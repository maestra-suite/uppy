{"version":3,"sources":["MultipartUploader.js"],"names":["AbortController","createAbortError","require","delay","MB","defaultOptions","limit","retryDelays","getChunkSize","file","Math","ceil","size","onStart","onProgress","onPartComplete","onSuccess","onError","err","ensureInt","value","parseInt","TypeError","MultipartUploader","constructor","options","abortController","key","uploadId","parts","createdPromise","Promise","reject","isPaused","partsInProgress","chunks","chunkState","catch","start","pause","abort","opts","undefined","really","signal","aborted","desiredChunkSize","minChunkSize","max","chunkSize","push","i","end","min","slice","map","uploaded","busy","done","resolve","then","createMultipartUpload","result","valid","listParts","forEach","part","PartNumber","Size","etag","ETag","some","p","every","state","need","completeChunks","filter","length","remainingChunks","minNeeded","candidates","index","partNumber","prePreparedPart","url","presignedUrls","headers","before","attempt","after","shouldRetry","source","status","doAttempt","retryAttempt","prepareUploadParts","partNumbers","reduce","candidate","sent","totalUploaded","n","c","body","defer","promise","xhr","XMLHttpRequest","open","Object","keys","setRequestHeader","responseType","cleanup","removeEventListener","onabort","addEventListener","upload","ev","lengthComputable","loaded","total","target","error","Error","getResponseHeader","send","sort","a","b","completeMultipartUpload","abortMultipartUpload","name","module","exports"],"mappings":"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","sourcesContent":["const { AbortController, createAbortError } = require('@uppy/utils/lib/AbortController')\r\nconst delay = require('@uppy/utils/lib/delay')\r\n\r\nconst MB = 1024 * 1024\r\n\r\nconst defaultOptions = {\r\n  limit: 1,\r\n  retryDelays: [0, 1000, 3000, 5000],\r\n  getChunkSize (file) {\r\n    return Math.ceil(file.size / 10000)\r\n  },\r\n  onStart () {},\r\n  onProgress () {},\r\n  onPartComplete () {},\r\n  onSuccess () {},\r\n  onError (err) {\r\n    throw err\r\n  },\r\n}\r\n\r\nfunction ensureInt (value) {\r\n  if (typeof value === 'string') {\r\n    return parseInt(value, 10)\r\n  }\r\n  if (typeof value === 'number') {\r\n    return value\r\n  }\r\n  throw new TypeError('Expected a number')\r\n}\r\n\r\nclass MultipartUploader {\r\n  constructor (file, options) {\r\n    this.options = {\r\n      ...defaultOptions,\r\n      ...options,\r\n    }\r\n    // Use default `getChunkSize` if it was null or something\r\n    if (!this.options.getChunkSize) {\r\n      this.options.getChunkSize = defaultOptions.getChunkSize\r\n    }\r\n\r\n    this.file = file\r\n    this.abortController = new AbortController()\r\n\r\n    this.key = this.options.key || null\r\n    this.uploadId = this.options.uploadId || null\r\n    this.parts = []\r\n\r\n    // Do `this.createdPromise.then(OP)` to execute an operation `OP` _only_ if the\r\n    // upload was created already. That also ensures that the sequencing is right\r\n    // (so the `OP` definitely happens if the upload is created).\r\n    //\r\n    // This mostly exists to make `#abortUpload` work well: only sending the abort request if\r\n    // the upload was already created, and if the createMultipartUpload request is still in flight,\r\n    // aborting it immediately after it finishes.\r\n    this.createdPromise = Promise.reject() // eslint-disable-line prefer-promise-reject-errors\r\n    this.isPaused = false\r\n    this.partsInProgress = 0\r\n    this.chunks = null\r\n    this.chunkState = null\r\n\r\n    this.#initChunks()\r\n\r\n    this.createdPromise.catch(() => {}) // silence uncaught rejection warning\r\n  }\r\n\r\n  /**\r\n   * Was this upload aborted?\r\n   *\r\n   * If yes, we may need to throw an AbortError.\r\n   *\r\n   * @returns {boolean}\r\n   */\r\n  #aborted () {\r\n    return this.abortController.signal.aborted\r\n  }\r\n\r\n  #initChunks () {\r\n    const chunks = []\r\n    const desiredChunkSize = this.options.getChunkSize(this.file)\r\n    // at least 5MB per request, at most 10k requests\r\n    const minChunkSize = Math.max(5 * MB, Math.ceil(this.file.size / 10000))\r\n    const chunkSize = Math.max(desiredChunkSize, minChunkSize)\r\n\r\n    // Upload zero-sized files in one zero-sized chunk\r\n    if (this.file.size === 0) {\r\n      chunks.push(this.file)\r\n    } else {\r\n      for (let i = 0; i < this.file.size; i += chunkSize) {\r\n        const end = Math.min(this.file.size, i + chunkSize)\r\n        chunks.push(this.file.slice(i, end))\r\n      }\r\n    }\r\n\r\n    this.chunks = chunks\r\n    this.chunkState = chunks.map(() => ({\r\n      uploaded: 0,\r\n      busy: false,\r\n      done: false,\r\n    }))\r\n  }\r\n\r\n  #createUpload () {\r\n    this.createdPromise = Promise.resolve().then(() => this.options.createMultipartUpload())\r\n    return this.createdPromise.then((result) => {\r\n      if (this.#aborted()) throw createAbortError()\r\n\r\n      const valid = typeof result === 'object' && result\r\n        && typeof result.uploadId === 'string'\r\n        && typeof result.key === 'string'\r\n      if (!valid) {\r\n        throw new TypeError('AwsS3/Multipart: Got incorrect result from `createMultipartUpload()`, expected an object `{ uploadId, key }`.')\r\n      }\r\n\r\n      this.key = result.key\r\n      this.uploadId = result.uploadId\r\n\r\n      this.options.onStart(result)\r\n      this.#uploadParts()\r\n    }).catch((err) => {\r\n      this.#onError(err)\r\n    })\r\n  }\r\n\r\n  async #resumeUpload () {\r\n    try {\r\n      const parts = await this.options.listParts({\r\n        uploadId: this.uploadId,\r\n        key: this.key,\r\n      })\r\n      if (this.#aborted()) throw createAbortError()\r\n\r\n      parts.forEach((part) => {\r\n        const i = part.PartNumber - 1\r\n\r\n        this.chunkState[i] = {\r\n          uploaded: ensureInt(part.Size),\r\n          etag: part.ETag,\r\n          done: true,\r\n        }\r\n\r\n        // Only add if we did not yet know about this part.\r\n        if (!this.parts.some((p) => p.PartNumber === part.PartNumber)) {\r\n          this.parts.push({\r\n            PartNumber: part.PartNumber,\r\n            ETag: part.ETag,\r\n          })\r\n        }\r\n      })\r\n      this.#uploadParts()\r\n    } catch (err) {\r\n      this.#onError(err)\r\n    }\r\n  }\r\n\r\n  #uploadParts () {\r\n    if (this.isPaused) return\r\n\r\n    // All parts are uploaded.\r\n    if (this.chunkState.every((state) => state.done)) {\r\n      this.#completeUpload()\r\n      return\r\n    }\r\n\r\n    // For a 100MB file, with the default min chunk size of 5MB and a limit of 10:\r\n    //\r\n    // Total 20 parts\r\n    // ---------\r\n    // Need 1 is 10\r\n    // Need 2 is 5\r\n    // Need 3 is 5\r\n    const need = this.options.limit - this.partsInProgress\r\n    const completeChunks = this.chunkState.filter((state) => state.done).length\r\n    const remainingChunks = this.chunks.length - completeChunks\r\n    let minNeeded = Math.ceil(this.options.limit / 2)\r\n    if (minNeeded > remainingChunks) {\r\n      minNeeded = remainingChunks\r\n    }\r\n    if (need < minNeeded) return\r\n\r\n    const candidates = []\r\n    for (let i = 0; i < this.chunkState.length; i++) {\r\n      const state = this.chunkState[i]\r\n      // eslint-disable-next-line no-continue\r\n      if (state.done || state.busy) continue\r\n\r\n      candidates.push(i)\r\n      if (candidates.length >= need) {\r\n        break\r\n      }\r\n    }\r\n    if (candidates.length === 0) return\r\n\r\n    this.#prepareUploadParts(candidates).then((result) => {\r\n      candidates.forEach((index) => {\r\n        const partNumber = index + 1\r\n        const prePreparedPart = { url: result.presignedUrls[partNumber], headers: result.headers }\r\n        this.#uploadPartRetryable(index, prePreparedPart).then(() => {\r\n          this.#uploadParts()\r\n        }, (err) => {\r\n          this.#onError(err)\r\n        })\r\n      })\r\n    })\r\n  }\r\n\r\n  #retryable ({ before, attempt, after }) {\r\n    const { retryDelays } = this.options\r\n    const { signal } = this.abortController\r\n\r\n    if (before) before()\r\n\r\n    function shouldRetry (err) {\r\n      if (err.source && typeof err.source.status === 'number') {\r\n        const { status } = err.source\r\n        // 0 probably indicates network failure\r\n        return status === 0 || status === 409 || status === 423 || (status >= 500 && status < 600)\r\n      }\r\n      return false\r\n    }\r\n\r\n    const doAttempt = (retryAttempt) => attempt().catch((err) => {\r\n      if (this.#aborted()) throw createAbortError()\r\n\r\n      if (shouldRetry(err) && retryAttempt < retryDelays.length) {\r\n        return delay(retryDelays[retryAttempt], { signal })\r\n          .then(() => doAttempt(retryAttempt + 1))\r\n      }\r\n      throw err\r\n    })\r\n\r\n    return doAttempt(0).then((result) => {\r\n      if (after) after()\r\n      return result\r\n    }, (err) => {\r\n      if (after) after()\r\n      throw err\r\n    })\r\n  }\r\n\r\n  async #prepareUploadParts (candidates) {\r\n    candidates.forEach((i) => {\r\n      this.chunkState[i].busy = true\r\n    })\r\n\r\n    const result = await this.#retryable({\r\n      attempt: () => this.options.prepareUploadParts({\r\n        key: this.key,\r\n        uploadId: this.uploadId,\r\n        partNumbers: candidates.map((index) => index + 1),\r\n        chunks: candidates.reduce((chunks, candidate) => ({\r\n          ...chunks,\r\n          // Use the part number as the index\r\n          [candidate + 1]: this.chunks[candidate],\r\n        }), {}),\r\n      }),\r\n    })\r\n\r\n    if (typeof result?.presignedUrls !== 'object') {\r\n      throw new TypeError(\r\n        'AwsS3/Multipart: Got incorrect result from `prepareUploadParts()`, expected an object `{ presignedUrls }`.',\r\n      )\r\n    }\r\n\r\n    return result\r\n  }\r\n\r\n  #uploadPartRetryable (index, prePreparedPart) {\r\n    return this.#retryable({\r\n      before: () => {\r\n        this.partsInProgress += 1\r\n      },\r\n      attempt: () => this.#uploadPart(index, prePreparedPart),\r\n      after: () => {\r\n        this.partsInProgress -= 1\r\n      },\r\n    })\r\n  }\r\n\r\n  #uploadPart (index, prePreparedPart) {\r\n    this.chunkState[index].busy = true\r\n\r\n    const valid = typeof prePreparedPart?.url === 'string'\r\n    if (!valid) {\r\n      throw new TypeError('AwsS3/Multipart: Got incorrect result for `prePreparedPart`, expected an object `{ url }`.')\r\n    }\r\n\r\n    const { url, headers } = prePreparedPart\r\n    if (this.#aborted()) {\r\n      this.chunkState[index].busy = false\r\n      throw createAbortError()\r\n    }\r\n\r\n    return this.#uploadPartBytes(index, url, headers)\r\n  }\r\n\r\n  #onPartProgress (index, sent) {\r\n    this.chunkState[index].uploaded = ensureInt(sent)\r\n\r\n    const totalUploaded = this.chunkState.reduce((n, c) => n + c.uploaded, 0)\r\n    this.options.onProgress(totalUploaded, this.file.size)\r\n  }\r\n\r\n  #onPartComplete (index, etag) {\r\n    this.chunkState[index].etag = etag\r\n    this.chunkState[index].done = true\r\n\r\n    const part = {\r\n      PartNumber: index + 1,\r\n      ETag: etag,\r\n    }\r\n    this.parts.push(part)\r\n\r\n    this.options.onPartComplete(part)\r\n  }\r\n\r\n  #uploadPartBytes (index, url, headers) {\r\n    const body = this.chunks[index]\r\n    const { signal } = this.abortController\r\n\r\n    let defer\r\n    const promise = new Promise((resolve, reject) => {\r\n      defer = { resolve, reject }\r\n    })\r\n\r\n    const xhr = new XMLHttpRequest()\r\n    xhr.open('PUT', url, true)\r\n    if (headers) {\r\n      Object.keys(headers).forEach((key) => {\r\n        xhr.setRequestHeader(key, headers[key])\r\n      })\r\n    }\r\n    xhr.responseType = 'text'\r\n\r\n    function cleanup () {\r\n      // eslint-disable-next-line no-use-before-define\r\n      signal.removeEventListener('abort', onabort)\r\n    }\r\n    function onabort () {\r\n      xhr.abort()\r\n    }\r\n    signal.addEventListener('abort', onabort)\r\n\r\n    xhr.upload.addEventListener('progress', (ev) => {\r\n      if (!ev.lengthComputable) return\r\n\r\n      this.#onPartProgress(index, ev.loaded, ev.total)\r\n    })\r\n\r\n    xhr.addEventListener('abort', () => {\r\n      cleanup()\r\n      this.chunkState[index].busy = false\r\n\r\n      defer.reject(createAbortError())\r\n    })\r\n\r\n    xhr.addEventListener('load', (ev) => {\r\n      cleanup()\r\n      this.chunkState[index].busy = false\r\n\r\n      if (ev.target.status < 200 || ev.target.status >= 300) {\r\n        const error = new Error('Non 2xx')\r\n        error.source = ev.target\r\n        defer.reject(error)\r\n        return\r\n      }\r\n\r\n      // This avoids the net::ERR_OUT_OF_MEMORY in Chromium Browsers.\r\n      this.chunks[index] = null\r\n\r\n      this.#onPartProgress(index, body.size, body.size)\r\n\r\n      // NOTE This must be allowed by CORS.\r\n      const etag = ev.target.getResponseHeader('ETag')\r\n\r\n      if (etag === null) {\r\n        defer.reject(new Error('AwsS3/Multipart: Could not read the ETag header. This likely means CORS is not configured correctly on the S3 Bucket. See https://uppy.io/docs/aws-s3-multipart#S3-Bucket-Configuration for instructions.'))\r\n        return\r\n      }\r\n\r\n      this.#onPartComplete(index, etag)\r\n      defer.resolve()\r\n    })\r\n\r\n    xhr.addEventListener('error', (ev) => {\r\n      cleanup()\r\n      this.chunkState[index].busy = false\r\n\r\n      const error = new Error('Unknown error')\r\n      error.source = ev.target\r\n      defer.reject(error)\r\n    })\r\n\r\n    xhr.send(body)\r\n\r\n    return promise\r\n  }\r\n\r\n  async #completeUpload () {\r\n    // Parts may not have completed uploading in sorted order, if limit > 1.\r\n    this.parts.sort((a, b) => a.PartNumber - b.PartNumber)\r\n\r\n    try {\r\n      const result = await this.options.completeMultipartUpload({\r\n        key: this.key,\r\n        uploadId: this.uploadId,\r\n        parts: this.parts,\r\n      })\r\n      this.options.onSuccess(result)\r\n    } catch (err) {\r\n      this.#onError(err)\r\n    }\r\n  }\r\n\r\n  #abortUpload () {\r\n    this.abortController.abort()\r\n\r\n    this.createdPromise.then(() => {\r\n      this.options.abortMultipartUpload({\r\n        key: this.key,\r\n        uploadId: this.uploadId,\r\n      })\r\n    }, () => {\r\n      // if the creation failed we do not need to abort\r\n    })\r\n  }\r\n\r\n  #onError (err) {\r\n    if (err && err.name === 'AbortError') {\r\n      return\r\n    }\r\n\r\n    this.options.onError(err)\r\n  }\r\n\r\n  start () {\r\n    this.isPaused = false\r\n    if (this.uploadId) {\r\n      this.#resumeUpload()\r\n    } else {\r\n      this.#createUpload()\r\n    }\r\n  }\r\n\r\n  pause () {\r\n    this.abortController.abort()\r\n    // Swap it out for a new controller, because this instance may be resumed later.\r\n    this.abortController = new AbortController()\r\n\r\n    this.isPaused = true\r\n  }\r\n\r\n  abort (opts = undefined) {\r\n    if (opts?.really) this.#abortUpload()\r\n    else this.pause()\r\n  }\r\n}\r\n\r\nmodule.exports = MultipartUploader\r\n"]}