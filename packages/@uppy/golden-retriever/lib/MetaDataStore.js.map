{"version":3,"names":["findUppyInstances","instances","i","localStorage","length","key","startsWith","push","slice","maybeParse","str","JSON","parse","cleanedUp","MetaDataStore","constructor","opts","expires","name","storeName","cleanup","load","savedState","getItem","data","metadata","save","Date","now","state","stringify","setItem","instanceID","removeItem","instanceIDs","forEach","id","obj"],"sources":["MetaDataStore.js"],"sourcesContent":["/**\n * Get uppy instance IDs for which state is stored.\n */\nfunction findUppyInstances () {\n  const instances = []\n  for (let i = 0; i < localStorage.length; i++) {\n    const key = localStorage.key(i)\n    if (key.startsWith('uppyState:')) {\n      instances.push(key.slice('uppyState:'.length))\n    }\n  }\n  return instances\n}\n\n/**\n * Try to JSON-parse a string, return null on failure.\n */\nfunction maybeParse (str) {\n  try {\n    return JSON.parse(str)\n  } catch {\n    return null\n  }\n}\n\nlet cleanedUp = false\nexport default class MetaDataStore {\n  constructor (opts) {\n    this.opts = {\n      expires: 24 * 60 * 60 * 1000, // 24 hours\n      ...opts,\n    }\n    this.name = `uppyState:${opts.storeName}`\n\n    if (!cleanedUp) {\n      cleanedUp = true\n      MetaDataStore.cleanup()\n    }\n  }\n\n  /**\n   *\n   */\n  load () {\n    const savedState = localStorage.getItem(this.name)\n    if (!savedState) return null\n    const data = maybeParse(savedState)\n    if (!data) return null\n\n    // Upgrade pre-0.20.0 uppyState: it used to be just a flat object,\n    // without `expires`.\n    if (!data.metadata) {\n      this.save(data)\n      return data\n    }\n\n    return data.metadata\n  }\n\n  save (metadata) {\n    const expires = Date.now() + this.opts.expires\n    const state = JSON.stringify({\n      metadata,\n      expires,\n    })\n    localStorage.setItem(this.name, state)\n  }\n\n  /**\n   * Remove all expired state.\n   */\n  static cleanup (instanceID) {\n    if (instanceID) {\n      localStorage.removeItem(`uppyState:${instanceID}`)\n      return\n    }\n\n    const instanceIDs = findUppyInstances()\n    const now = Date.now()\n    instanceIDs.forEach((id) => {\n      const data = localStorage.getItem(`uppyState:${id}`)\n      if (!data) return\n      const obj = maybeParse(data)\n      if (!obj) return\n\n      if (obj.expires && obj.expires < now) {\n        localStorage.removeItem(`uppyState:${id}`)\n      }\n    })\n  }\n}\n"],"mappings":"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"}