{"version":3,"names":["UIPlugin","h","Editor","packageJson","locale","ImageEditor","constructor","uppy","opts","save","saveBlobCallback","blob","currentImage","getPluginState","setFileState","id","data","size","preview","updatedFile","getFile","emit","setPluginState","croppedCanvas","cropper","getCroppedCanvas","width","setData","height","cropperOptions","croppedCanvasOptions","toBlob","type","quality","storeCropperInstance","selectFile","file","title","defaultLocale","defaultCropperOptions","viewMode","background","autoCropArea","responsive","minCropBoxWidth","minCropBoxHeight","defaultActions","revert","rotate","granularRotate","flip","zoomIn","zoomOut","cropSquare","cropWidescreen","cropWidescreenVertical","defaultOptions","actions","i18nInit","canEditFile","isRemote","fileTypeSpecific","split","test","install","target","mount","uninstall","unmount","render","i18n","VERSION","version"],"sources":["ImageEditor.jsx"],"sourcesContent":["import { UIPlugin } from '@uppy/core'\nimport { h } from 'preact'\n\nimport Editor from './Editor.jsx'\nimport packageJson from '../package.json'\nimport locale from './locale.js'\n\nexport default class ImageEditor extends UIPlugin {\n  static VERSION = packageJson.version\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.id = this.opts.id || 'ImageEditor'\n    this.title = 'Image Editor'\n    this.type = 'editor'\n\n    this.defaultLocale = locale\n\n    const defaultCropperOptions = {\n      viewMode: 0,\n      background: false,\n      autoCropArea: 1,\n      responsive: true,\n      minCropBoxWidth: 70,\n      minCropBoxHeight: 70,\n      croppedCanvasOptions: {},\n    }\n\n    const defaultActions = {\n      revert: true,\n      rotate: true,\n      granularRotate: true,\n      flip: true,\n      zoomIn: true,\n      zoomOut: true,\n      cropSquare: true,\n      cropWidescreen: true,\n      cropWidescreenVertical: true,\n    }\n\n    // Why is the default quality smaller than 1?\n    // Because `quality: 1` increases the image size by orders of magnitude - 0.8 seems to be the sweet spot.\n    // (see https://github.com/fengyuanchen/cropperjs/issues/538#issuecomment-1776279427)\n    const defaultOptions = {\n      quality: 0.8,\n    }\n\n    this.opts = {\n      ...defaultOptions,\n      ...opts,\n      actions: {\n        ...defaultActions,\n        ...opts?.actions,\n      },\n      cropperOptions: {\n        ...defaultCropperOptions,\n        ...opts?.cropperOptions,\n      },\n    }\n\n    this.i18nInit()\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  canEditFile (file) {\n    if (!file.type || file.isRemote) {\n      return false\n    }\n\n    const fileTypeSpecific = file.type.split('/')[1]\n\n    if (/^(jpe?g|gif|png|bmp|webp)$/.test(fileTypeSpecific)) {\n      return true\n    }\n\n    return false\n  }\n\n  save = () => {\n    const saveBlobCallback = (blob) => {\n      const { currentImage } = this.getPluginState()\n\n      this.uppy.setFileState(currentImage.id, {\n        data: blob,\n        size: blob.size,\n        preview: null,\n      })\n\n      const updatedFile = this.uppy.getFile(currentImage.id)\n      this.uppy.emit('thumbnail:request', updatedFile)\n      this.setPluginState({\n        currentImage: updatedFile,\n      })\n      this.uppy.emit('file-editor:complete', updatedFile)\n    }\n\n    const { currentImage } = this.getPluginState()\n\n    // Fixes black 1px lines on odd-width images.\n    // This should be removed when cropperjs fixes this issue.\n    // (See https://github.com/transloadit/uppy/issues/4305 and https://github.com/fengyuanchen/cropperjs/issues/551).\n    const croppedCanvas = this.cropper.getCroppedCanvas({})\n    if (croppedCanvas.width % 2 !== 0) {\n      this.cropper.setData({ width: croppedCanvas.width - 1 })\n    }\n    if (croppedCanvas.height % 2 !== 0) {\n      this.cropper.setData({ height: croppedCanvas.height - 1 })\n    }\n\n    this.cropper.getCroppedCanvas(this.opts.cropperOptions.croppedCanvasOptions).toBlob(\n      saveBlobCallback,\n      currentImage.type,\n      this.opts.quality,\n    )\n  }\n\n  storeCropperInstance = (cropper) => {\n    this.cropper = cropper\n  }\n\n  selectFile = (file) => {\n    this.uppy.emit('file-editor:start', file)\n    this.setPluginState({\n      currentImage: file,\n    })\n  }\n\n  install () {\n    this.setPluginState({\n      currentImage: null,\n    })\n\n    const { target } = this.opts\n    if (target) {\n      this.mount(target, this)\n    }\n  }\n\n  uninstall () {\n    const { currentImage } = this.getPluginState()\n\n    if (currentImage) {\n      const file = this.uppy.getFile(currentImage.id)\n      this.uppy.emit('file-editor:cancel', file)\n    }\n    this.unmount()\n  }\n\n  render () {\n    const { currentImage } = this.getPluginState()\n\n    if (currentImage === null || currentImage.isRemote) {\n      return null\n    }\n\n    return (\n      <Editor\n        currentImage={currentImage}\n        storeCropperInstance={this.storeCropperInstance}\n        save={this.save}\n        opts={this.opts}\n        i18n={this.i18n}\n      />\n    )\n  }\n}\n"],"mappings":"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"}